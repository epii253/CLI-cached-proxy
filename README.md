# Caching Proxy (look-through)

Простой учебный HTTP-прокси на C++, который пробрасывает запросы к одному заранее заданному origin, кэширует ответы в Redis и выполняет валидацию по `ETag` / учёт `Age`.  
Сделан как демонстрация практических бэкенд-навыков: работа с сокетами, HTTP-заголовками, многопоточность, интеграция с внешними библиотеками (cpr, redis++) и базовые принципы HTTP-кэширования.

> **Коротко:** клиент → `localhost:PORT` → **proxy** → (Redis cache) → origin.  
> Поддерживаемые методы: `GET`, `HEAD`, `POST` (без chunked), `PUT`.  
> Каждый клиент обрабатывается в своём `std::thread` (модель «один поток на соединение»).

---

## Что делает проект

- Проксирует HTTP-запросы к одному origin.
- кэширует ответы `GET` в Redis с TTL.
- Валидирует кэш по `ETag` (использует `If-None-Match` / обрабатывает `304 Not Modified`).
- Поддерживает учёт `Age` (сохраняется timestamp в кэше).
- Убирает hop-by-hop заголовки, корректно управляет `Content-Length` / `Transfer-Encoding` (в пределах текущей реализации).
- Логирует события: `accept`, `request`, `cache hit/miss`, ответ origin.

---

## Ключевые возможности

- Простая и понятная схема «look-through» проксирования.
- кэширование в Redis с минимальной логикой invalidation.
- Подчёркнутое внимание на:
  - правильной работе с HTTP-заголовками (CRLF, hop-by-hop);
  - корректной пересылке тела и пересчёте заголовков при модификации;
  - использованию C++ многопоточности и безопасному shutdown.

---

## Архитектура

```
[Client] ---> [Proxy (localhost:PORT)] <---> [Redis cache] (store: body, headers, etag) ---> [Origin]
                  
```

Поток обработки (упрощённо):

1. `accept()` соединение → создаётся поток.
2. Парсинг стартовой строки/заголовков.
3. Для `GET` и `HEAD`:
   - Проверка Redis по ключу (normalized URL).
   - Если hit и свежо → отдать из кэша.
   - Если hit и есть `ETag` → отправить `If-None-Match` к origin.
   - Если miss или origin дал новый контент → сохранить в Redis (Если это предусматривают заголовки и статус-код) и отдать клиенту.
4. Для `POST`, `PUT` — проксирование (POST буферизуется; chunked POST не поддерживается).

---

## Чему этот проект учит (коротко)

- низкоуровневому HTTP (формат запроса/ответа, CRLF, заголовки),
- работе с сокетами и `accept`/`read`/`write`,
- многопоточности на C++ (`std::thread`, безопасный shutdown / join),
- интеграции с внешними библиотеками: `cpr`/`libcurl` и `redis++`/`hiredis`,
- основам HTTP-кэширования: `ETag`, `If-None-Match`, `Age`, TTL, hop-by-hop заголовки.

Важно: это учебный проект — не претендует на полноту production-фич.

---

## Ограничения / известные нюансы

- Поддерживает `GET`, `HEAD`, `POST` (POST — без chunked, body буферизуется).
- Модель конкуренции: один поток на соединение → годится для низкой/средней нагрузки.
- Проксирование HTTPS через `CONNECT` не реализовано.
- Content-Encoding — данные принимаются в недекодированном формате (побайтово) и пересылаются на `origin` 
- Redis отвечает за кэширование; потеря Redis ведёт к тому, что кэш восстанавливается пустым (обычное поведение кэша).
- Приложенный Dockerfile может не работать на системах, которые по умолчанию используют `Transfer-Encoding: chunked` для http-общения.
---

## Зависимости

Минимальные:
- C++17 (gcc)
- CMake ≥ 3.12
- libcurl (dev)
- cpr (обертка над libcurl), либо можно напрямую использовать libcurl
- redis++ (redis-plus-plus) и hiredis
- Redis server для тестирования

---

## Конфигурация

Redis читает параметры из конфиг-файла для :

- Взят стандартный redis.conf
- - Изменено `save 60 20` (Сохранят снимок данных каждые 60 секунд если произошло хотя бы 20 изменений)
- - Изменен путь сохранения снимков (в CLI-cached-proxy/cache/ каталог)
---

## Запуск (локально)


### Пример запуска прокси (локально, после сборки)
```bash

./bin/caching-proxy --port 5000 --origin https://cppreference.com
```


## Roadmap / идеи для улучшений

- Ввести валидацию доступа к Redis серверу (локальному).
- Ручного управление кэшем (Очищение по команде и точечное удаление по ключу).
- Добавить chunked возможность для POST (возможны ограничения библиотекой cpr).
---
